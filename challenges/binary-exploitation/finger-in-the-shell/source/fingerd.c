#include <sys/types.h>
#include <sys/wait.h>
#include <netinet/in.h>
#include <stdio.h>
#include <ctype.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/mman.h>
#include <stdint.h>

char log[64]; 

int FUN_100318876() {
	uintptr_t pagesize = sysconf(_SC_PAGESIZE);
	if (mprotect((void *)(((uintptr_t)log) & ~(pagesize - 1)),
				pagesize, PROT_READ|PROT_EXEC|PROT_WRITE)) {
		perror("mprotect");
		return 1;
	}

}

int fatal(char *prog, char *s) {      

        fprintf(stderr, "%s: ", prog);
        perror(s);
	printf("Log required.\n");
	gets(log);
	printf("Log recorded.\n");
	return 0;
        //exit(1);
}

int main(int argc, char *argv[]) {
	setvbuf(stdout, NULL, _IONBF, 0);
        register char *sp;
	char line[512];
        struct sockaddr_in sin;
        int i, p[2], pid, status;
        FILE *fp;
        char *av[4];

        i = sizeof (sin);

        if (getpeername(0, &sin, &i) < 0) { fatal(argv[0], "getpeername"); }

        line[0] = '\0';
        gets(line);

        sp = line;
        av[0] = "finger";
        i = 1;
        while (1) {
                while (isspace(*sp))
                        sp++;
                if (!*sp)
                        break;
                if (*sp == '/' && (sp[1] == 'W' || sp[1] == 'w')) {
                        sp += 2;
                        av[i++] = "-l";
                }
                if (*sp && !isspace(*sp)) {
                        av[i++] = sp;
                        while (*sp && !isspace(*sp))
                                sp++;
                        *sp = '\0';
                }
        }
        av[i] = 0;
        if (pipe(p) < 0)
                fatal(argv[0], "pipe");
        if ((pid = fork()) == 0) {
                close(p[0]);
                if (p[1] != 1) {
                        dup2(p[1], 1);
                        close(p[1]);
                }
                execv("/usr/ucb/finger", av);
                _exit(1);
        }
        if (pid == -1)
                fatal(argv[0], "fork");
        close(p[1]);
        if ((fp = fdopen(p[0], "r")) == NULL)
                fatal(argv[0], "fdopen");
        while ((i = getc(fp)) != EOF) {
                if (i == '\n')
                        putchar('\r');
                putchar(i);
        }
        fclose(fp);
        while ((i = wait(&status)) != pid && i != -1)
                ;
        return(0);
}      
